# 1. 反実仮想
# 2. 潜在的結果変数とルービン因果モデル
ハーバード大学のルービン教授が1970年代に提案した”ルービン因果モデル”を説明する為の記号を導入する.
- 説明の簡便の為、”もし～”として考える条件は1つだけとする.
- 変数Zを介入の有無を示す2値変数($Z=0, 1$)とする。(=原因変数)
- Yを結果変数(アウトカム)とする.
  - 反実仮想の考え方を利用するので、Yは本来2変数あると考える。
  - 具体的には、$Y_0$を"もしその人がZ=0という条件を受けた場合の結果変数", $Y_1$を"もしその人がZ=1という条件を受けた場合の結果変数"とする.

例として、「あるスマホゲームを運営している企業が認知度や利用率を高めるべくテレビCMを打つとして、CMの効果検証をする」ことを考える。
効果検証のKPIは、ここではゲームの利用時間とする。
具体的には、ある2週間の間にCM接触したらZ=1、非接触ならZ=0とし、その後の2週間の利用時間を調べる。
ここで、Y_1とY_0はそれぞれ、ある人の
- $Y_1$:テレビCMを見た場合の、ゲーム利用時間
- $Y_0$:テレビCMを見なかった場合の、ゲーム利用時間
  
とする。

ここで重要なのは、**Y_1とY_0は同時には測定できない**、という事である。
そこでY_1とY_0を、Zの値にかかわらず**潜在的には存在し得る**がZの値によって観測できるものが違う、ということから**潜在的結果変数(Potential outcomes)**と呼ぶ。

このようにルービン因果モデルでは、同じ人に"本来はどちらの潜在的結果変数も存在する"、という発想をする事で、"もし～していたら"と"もし～していなかったら"の比較が可能になるわけである。

ここで、見た目のゲーム利用時間Yは、潜在的結果変数Y_1, Y_0とZを使って以下の式で表す事ができる.
$$Y=Z \times Y_1 + (1-Z)\times Y_0 \tag{1}$$
この様に表現すれば、観測値YはZ=1ならY_1、Z=0ならY_0になる!

さて、CMが利用時間に与える効果はどのように表現できるか？？
Y_1もY_0も観測できるなら、
$Y_1 -Y_0$
を「CMを見せた場合と見せなかった場合の差」として定義するのが自然である。
これを**個人レベルの因果効果** または、**個人レベルの処置効果**と呼ぶ。
もしこれが分かれば最高なのですが...。

# 3. 因果推論の根本問題と集団としての因果効果
## 個人としての因果効果は推定できない...!
しかしほとんどの場合、ある選択をした場合に「それ以外の選択をした場合に得られたであろう結果」を知る事はできない。
タイムスリップができない以上、個人としての因果効果は通常推定ができない...。

## 集団としての因果効果(ATE)
このように個人レベルの因果効果は知る事はできないが、代わりに特定の母集団全体で因果効果がどの程度あるかを考える事は、ビジネスや政策、医療などでは重要になる。
- これが通常の**因果効果**、あるいは**平均処置効果(Average Treatment Effect, ATE)**といわれるもの。
- 以下の、母集団における$Y_1 - Y_0$の期待値で表される。
$$ ATE = E(Y_1-Y_0) = E(Y_1) - E(Y_0)$$

- 上の例で言えば、$「母集団全ての人にCMを見せた場合の利用時間の平均」- 「全ての人にCMを見せなかった場合の利用時間の平均」$である。

## ATEをどうやって？？
ではどうやってATEを推定したらよいのか？？

母集団における因果効果をデータから推定する為の前準備として、現在データが得られているのがN人(サンプルサイズ)とし、顧客(または個人などの解析の単位)iに対する値には添え字iを付ける.

さて、もし潜在的結果変数をどちらも観測できるならば、ATEは...
$$ATE=\frac{1}{N} \sum^{N}_{i=1}{(Y_{i1} - Y_{i0})} $$
を用いれば正しく推定できる.(＝ATEの不偏推定量!!)
しかし実際には、$Y_{i1}$と$Y_{i0}$を同時に観測する事はできない...。

一方で、CMの効果指標として利用しがちな、単純な「CM接触群での利用時間の平均」と「CM非接触群での利用時間の平均」の差は
$$\frac{\sum^{N}_{i=1}{Z_i Y_i}}{\sum^{N}_{i=1}{Z_i}} - 
\frac{\sum^{N}_{i=1}{(1-Z_i) Y_i}}{\sum^{N}_{i=1}{(1-Z_i)}} \tag{2}$$
と表現できる.
(分母のZは、sumする観測値がZ=1のみ、Z=0のみになるようにコントロールしてる!!)
しかしこれはあくまで、
$$E(Y_1|Z=1) - E(Y_0|Z=0) \tag{3}$$
についての不偏推定量であって、ATEの不偏推定量にはならない...。

介入(Z)の対象かどうかをランダムに決める事ができない以上、**事前に存在する処置群(Z=1)と対照群(Z=0)間で差のある変数で、かつ結果変数に影響を与えるもの**(=**共変量, covariateと呼ぶ=交絡因子**??)の影響を除去して評価する必要がある！

## ATE以外の重要な因果効果の指標
- 処置群における平均処理効果(Average Treat Effect on the Treated:ATT)
$$ ATT =E(Y_1 -Y_0|Z=1)$$
- 対照群における平均処置効果(Average Treatment Effect on the Untreated:ATU)
$$ ATU =E(Y_1 -Y_0|Z=0)$$

ATTは「その施策を実施した対象者集団(Z=1)での、実施した場合Y_1と実施しなかった場合Y_0との差の期待値」、例えば**マーケティング施策の投資収益率(ROI)を計算する場合など、その施策から得られる本来の利益を計算する為に使われる**！(=使うのが望ましい！)
ATUは「実施対象ではなかった人々(Z=0)に、もし実施した時の効果」です。なので**この施策の対象を広げるべきか**を考える判断材料になる。

## 単純な群間差が因果効果ATEの不偏推定量になるケース
それは、無作為化比較対照実験(Randomized Controlled Trail：RCT)、つまり**ランダムにZの値が決まる場合**である！

例えば、WebページのABテスト的な発想で、顧客を"CMを見せる顧客"と"CMを見せない顧客"にランダムに2群に分けて、CMの効果を比較する場合に当たる。
この場合、両群はランダムに振り分けられただけなので2つの群は等質、従って期待値は2群間で等しくなります！
$$E(Y_k|Z=1) = E(Y_k|Z=0) = E(Y_k),(k=1, 0)\tag{4}$$
よって、式(3)そのものがATEになるので、式(2)がATEの不偏推定量になる。
同様に、ATTもATUも全て、式(2)の単純な平均値の差によってBiasなく推定できる.

ではランダムな実験RCTを行えばよいか、というとRCTそのものが難しかったり、RCTでは推定できなかったりします...！

# 4. 調査観察データからの因果効果推定の仮定
## 強い意味での無視可能性とは？
ではRCTが行えない場合には、どのように因果効果を推定すればよいか？？
潜在的結果変数を同時にすべて観測する事はできないので、ATEを推定するには何か追加的な仮定が必要になるが、普通は以下の「強い意味での無視可能性(strong igrorability)」と呼ばれる仮定を置く.

$$p(Z|Y_1, Y_0, X)=p(Z|X)$$
ここで、XはインディケータZにもアウトカムY_1, Y_0にも影響を与える共変量。
これはつまり、「**『Zが1になるか0になるか、つまりどちらの条件になるかの確率』は、共変量Xを条件付けると潜在的結果変数には影響されない**」、という事を示している。
(すなわち、**ZとYにおける交絡因子はXだけであり、Xさえ固定すればBiasは除去できる！という仮定**？？）

上記の仮定をベイズの定理を使って言い換えると以下のようになり、これは「群別Zと潜在的結果変数は、共変量を条件付けると独立」である事を示している。
$$p(Y_1, Y_0|Z, X) = p(Y_1, Y_0|X)\tag{5}$$ 

また、この式から以下の式が導かれる。(同時確率=>1変数?)
$$p(Y_k|Z, X) = p(Y_k|X), (k=1, 0)$$

この式によって以下のように表現できる。
$$E(Y_k) = E_X[E(Y_k |X)] (ここまでは自明?)\\
= E_X[E(Y_k |Z, X)] \tag{6} (ここは仮定より)$$

この式(6)は、潜在的結果変数の期待値$E(Y_k)$を求める際、観測値からは推定できない$E(Y_k|X)$の代わりに、観測値から推定できる$E(Y_k|Z=k, X)$を用いて、$E(Y_k)$やATEを推定できる事を示している！(具体的な方法は5節)

## どういう場合に仮定が成立する？？成立しない？？

# 5. 因果効果の推定法
さて、式(5)の仮定の下で、ATEを推定する具体的な方法を以下にいくつかまとめる。

## 5.1. 回帰モデルを用いた方法
潜在的結果変数を共変量で説明する回帰モデル(=**説明変数が共変量、被説明変数が潜在的結果変数の回帰モデル**)が、平均ゼロで共変量xと相関のない確率変数である誤差項$\epsilon_1$と$\epsilon_0$を用いて(=線形回帰の誤差項の仮定)、
$$y_{i1}=\tau_1 + g_1(x_i) + \epsilon_1$$
$$y_{i0}=\tau_0 + g_0(x_i) + \epsilon_0 \tag{7}$$
と表されるとする。(ここでは簡単の為、yは連続変数である場合について議論するが、**離散変数の場合も以下の議論は本質的には同じ**.)
また、ここで2つの誤差項の間には相関があっても構わないし、関数gは非線形でも構わない。

この時、ATEは、
$$ATE=E(y_1-y_0)= E(y_1) - E(y_0) \\
= E(\tau_1 + g_1(x)) - E(\tau_0 + g_0(x)) \\
= \tau_1 + E(g_1(x)) - \tau_0 - E(g_0(x)) \\
= \tau_1 - \tau_0 - E[g_1(x) - g_0(x)] \tag{8}$$
と表現できる。
式(5)の仮定が成立している場合、「母集団におけるxを所与としたy_1の条件付き分布($p(y_1|x)$)」は「z=1である部分集団におけるxを所与としたy_1の条件付き分布($p(y_1|z=1, x)$)」と一致する。($p(y_1|x)=p(y_1|z=1, x)$)
従って、**処置群(z=1)のデータだけからy_1のxへの回帰関数g_1を推定する事が可能**。

同様にg_0も対照群(z=0)のデータだけを用いて推定可能。よって**式(8)の右辺はそれぞれ推定値や推定された関数で置き換える事ができ**、**観測データから因果効果ATEの推定が可能になる**。

### 単純に得られた結果変数yをzとxで説明するモデルの場合は...
さて、通常の回帰分析では**潜在的結果変数という概念を考えず**に、通常のインディケーター変数(原因変数)z、共変量xを同時に説明変数に投入し、結果変数を予測する。
**この解析法と上記の考え方の違いは何だろうか**？？

式(1)に式(7)を代入すると、潜在的結果変数を背後に考えずに単純に得られた結果変数yをzとxで説明する形式のモデルは...
  $$y_i =z_i \times y_{i1} + (1-z_i)\times y_{i0} \\
= z_i \times (\tau_1 + g_1(x_i) + \epsilon_1) + (1-z_i)\times (\tau_0 + g_0(x_i) + \epsilon_0) \\
= \tau_0 + (\tau_1 - \tau_0)z_i + [g_1(x_i)z_i + g_0(x_i)(1-z_i)] + \epsilon_{i1}z_i + \epsilon_{i0}(1 - z_i) \tag{9}$$
と表す事ができる。**特に関数$g_1=g_0=g$の場合**は、
$$ y_i =  \tau_0 + (\tau_1 - \tau_0)z_i + g(x_i) + (\epsilon_{i1} - \epsilon_{i0})z_i + \epsilon_{i0}\tag{10}$$
である。
また$g_1=g_0=g$と式(8)より、$ATE=E(y_1-y_0)=\tau_1 - \tau_0 - E[g(x) - g(x)]=\tau_1 - \tau_0$となる。
これは、**ATEが式(9)におけるzの回帰係数と一致する事**を示している。

つまり、インディケータ変数z、共変量xを説明変数とする(潜在的結果変数を明示的に考えない)単純な回帰分析を行うという事は、**$g_1=g_0$というかなり強い仮定を置いている**、という事になります。
($\epsilon_1$と$\epsilon_0$の分布が等しいという仮定も推定に必要...!)

## $g_1=g_0$の仮定の意味
この仮定はどういう事かというと、例えば特別な教育プログラムの例で共変量として"事前の学力"を考えてみる。
事前の学力が高い生徒はより洗練された解答方略をすでに持っているので、低学力向けの解答方略を強制される特別な教育プログラムを受けると**かえって成績が下がる可能性があり**、**$g_1=g_0$でない可能性が高い**為、単純な回帰を行うとATEの推定が正しく行えない。

## 5.2. マッチングと層別解析
マッチングは上記の様な回帰モデルの仮定がなくても利用できる方法である。
具体的には、「特別な介入やプログラムを受けた(介入群にいる)iさん」の共変量の値と同じ(=**完全マッチング**)、あるいは近い(=**距離を使ったマッチング**)共変量の値を持っているが、介入を受けていない(対照群にいる)jさんは"**同じ人とみなす事ができる**"と考える。
すると二人は同じ人なので、iさんのYの値をY_1とし、jさんのYの値をY_0とすれば、あたかも2つの潜在的結果変数の両方がわかり、その差を取れば因果効果が推定できる！

## 5.3. 傾向スコア
推定したいのが式(7)の回帰関数そのものではなくATEである場合には、**傾向スコア(propensity score)を用いた解析**がよく利用される。傾向スコアとはローゼンバウムとルービンが1983年に提案した概念であり、**共変量x_iを持つiさんが処置群(z=1)に存在する確率**：
$$e(x_i) = Pr(Z_i=1|X_i=x_i) \tag{11}$$
をiさんの傾向スコアと呼ぶ。傾向スコアは各個人に対する確率値なので、多次元のXと異なり、**0~1の値を取る1次元の変数**である.
ここで式(5)が成立していれば、この傾向スコア(一次元)を用いた調整を行えば、共変量X(多次元)すべてについて調整を行った事と同じになる事が知られている。

さて、**多次元の共変量を傾向スコアとして一次元化する事の利益**はなんだろうか？？
ここで考えたいのは、学術研究でも実務でもおよそ因果効果を推定したい場合には、**結果変数として複数の指標を用いる事が多い**、**成果指標は通常は複数あるもの**、という事である。
(ex. CMの効果の場合、CM放映後の「利用率」「利用頻度」「利用時間」)
(ex2. 教育プログラムの場合、受講後の「成績」「学習意欲」「効率的な学習方法を身につけられたかどうか」)

従って結果変数は指標の数×(条件が2つ=介入の有無のみなら)2あり、共変量は多数にわたります。
この場合、**多変量と多変量の回帰関係をモデリングしなければならず**、モデル構造の誤設定によるATE推定のBiasが気にする必要がある...!

一方で傾向スコアを用いた解析では、**「一次元であるインディケータ変数zを共変量で説明する」式(11)の(次元の小さい)モデルを正しく設定すればよい**！
(式(7)のような「指標の数×２の次元の潜在的結果変数を共変量で説明する」(次元の大きい)モデルの特定が不要！)

さて、傾向スコアを用いた因果効果の推定法では、以下の二段階で解析を行う.
1. 各対象毎に傾向スコアを推定する.
    - ロジスティック回帰やプロビット回帰(?)から得られる予測確率が利用されることが通常。
    - 機械学習モデルを用いるといった方法も提案できる
2. 推定した傾向スコアを用いて因果効果を推定する.
    - 推定手法は以下の大きく4種に分類できる.
    1. 傾向スコアを用いたマッチング・層別解析
    2. 傾向スコアによる共分散分析
    3. 傾向スコアによる逆確率重み付け法
    4. 二重にロバストな推定法
### 5.3.1. 傾向スコアを用いたマッチング・層別解析

### 5.3.2. 傾向スコアによる共分散分析
### 5.3.3. 傾向スコアによる逆確率重み付け法
### 5.3.4. 二重にロバストな推定法
# 6. 共変量の選択問題
# 7. 操作変数法
